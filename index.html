<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Конструктор отчетных таблиц ОАТИ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>
  <script src="app.js" type="module" defer></script>
</head>
<body>
  <!-- Шапка приложения: приветственный блок с кратким описанием. -->
  <header class="app-header">
    <div class="header-brand">
      <img src="дизайн/ЛОГО.svg" alt="Логотип Контроль Москвы" class="brand-logo" />
      <div class="brand-text">
        <span class="brand-tag">Контроль Москвы</span>
        <h1>Конструктор отчетных таблиц ОАТИ</h1>
      </div>
    </div>
    <p class="header-subtitle">
      Единая рабочая среда для формирования отчетов: загрузите исходные данные, сопоставьте поля и получите сверстанный файл
      за несколько кликов.
    </p>
  </header>

  <main class="app-main">
    <!-- Блок загрузки исходных таблиц. -->
    <section class="card">
      <h2>1. Загрузка исходных данных</h2>
      <div class="file-input-group">
        <!-- Здесь загружаем таблицу с нарушениями. -->
        <label for="violations-file" class="file-label">Таблица по нарушениям (Excel)</label>
        <input type="file" id="violations-file" accept=".xlsx,.xls" />
      </div>
      <div class="file-input-group">
        <!-- А этот инпут для перечня объектов контроля. -->
        <label for="objects-file" class="file-label">Таблица по объектам (Excel)</label>
        <input type="file" id="objects-file" accept=".xlsx,.xls" />
      </div>
      <p class="hint">Файлы обрабатываются только в браузере, без отправки на сервер.</p>
    </section>

    <!-- Настройка сопоставления колонок для двух таблиц. -->
    <section class="card" id="mapping-section" hidden>
      <h2>2. Настройка соответствия столбцов</h2>
      <div class="mapping-grid">
        <div>
          <!-- Сопоставление для таблицы нарушений. -->
          <h3>Таблица нарушений</h3>
          <div id="violations-mapping" class="mapping-list"></div>
        </div>
        <div>
          <!-- Сопоставление для перечня объектов. -->
          <h3>Перечень объектов</h3>
          <div id="objects-mapping" class="mapping-list"></div>
        </div>
      </div>
      <p class="hint">Проверьте, что для каждого требуемого поля выбран корректный столбец. Значения подставляются автоматически, но их можно изменить.</p>
    </section>

    <!-- Фильтры по периодам и типам объектов. -->
    <section class="card" id="controls-section" hidden>
      <h2>3. Параметры отчета</h2>
      <div class="controls-grid">
        <fieldset>
          <!-- Выбор дат для отчётного периода. -->
          <legend>Отчетный период</legend>
          <label>
            Начало периода
            <select id="current-start"></select>
          </label>
          <label>
            Конец периода
            <select id="current-end"></select>
          </label>
        </fieldset>
        <fieldset>
          <!-- Вторая пара select'ов отвечает за предыдущий период. -->
          <legend>Предыдущий период</legend>
          <label>
            Начало периода
            <select id="previous-start"></select>
          </label>
          <label>
            Конец периода
            <select id="previous-end"></select>
          </label>
        </fieldset>
        <fieldset>
          <!-- Радиокнопки переключают режим фильтрации по типам объектов. -->
          <legend>Типы объектов контроля</legend>
          <label class="inline-option">
            <input type="radio" name="type-mode" value="all" checked />
            Все типы объектов
          </label>
          <label class="inline-option">
            <input type="radio" name="type-mode" value="custom" />
            Выбрать до трех типов
          </label>
          <div id="type-options" class="type-options" aria-live="polite"></div>
          <p id="type-message" class="hint" role="status" aria-live="polite"></p>
        </fieldset>
        <fieldset>
          <legend>Наименования нарушений</legend>
          <label class="inline-option">
            <input type="radio" name="violation-mode" value="all" checked />
            Все наименования
          </label>
          <label class="inline-option">
            <input type="radio" name="violation-mode" value="custom" />
            Выбрать до пяти наименований
          </label>
          <div id="violation-options" class="violation-options" aria-live="polite"></div>
          <p id="violation-message" class="hint" role="status" aria-live="polite"></p>
        </fieldset>
        <fieldset>
          <legend>Источник данных</legend>
          <label>
            Выбор источника
            <select id="data-source-filter">
              <option value="oati">ОАТИ</option>
              <option value="cafap">ЦАФАП</option>
              <option value="all" selected>ОАТИ и ЦАФАП</option>
            </select>
          </label>
          <p id="data-source-message" class="hint" aria-live="polite"></p>
        </fieldset>
      </div>
      <p class="hint">При выборе пользовательских типов можно отметить не более трех значений.</p>
      <p class="hint">Для пользовательского выбора нарушений доступно до пяти наименований.</p>
    </section>

    <!-- Предпросмотр и управление выгрузкой отчёта. -->
    <section class="card" id="preview-section" hidden>
      <div class="preview-header">
        <h2>4. Предпросмотр отчётной таблицы</h2>
        <div class="preview-actions">
          <!-- Кнопка пересчёта вызывает пересборку отчёта без повторной загрузки файлов. -->
          <button id="refresh-report" type="button">Пересчитать</button>
          <!-- Выгрузка в Excel становится активной только после успешного пересчёта. -->
          <button id="download-report" type="button" disabled>Выгрузить в Excel</button>
        </div>
      </div>
      <p id="preview-message" class="hint"></p>
      <div class="table-wrapper">
        <table id="report-table"></table>
      </div>
    </section>
  </main>

  <!-- Подвал со служебной подписью. -->
  <footer class="app-footer">
    <p>Формирование отчетов согласно правилам из предоставленных файлов. Все вычисления выполняются локально.</p>
  </footer>
</body>
</html>
