<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="light dark" />
  <meta name="referrer" content="no-referrer" />
  <meta
    http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self' https://fonts.googleapis.com https://fonts.gstatic.com https://cdn.jsdelivr.net; frame-ancestors 'self'; base-uri 'self'; form-action 'self'"
  />
  <title>Конструктор отчетных таблиц ОАТИ</title>
  <link rel="icon" type="image/svg+xml" href="дизайн/ЛОГО.svg" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>
  <script src="app.js" type="module" defer></script>
</head>
<body class="theme-light">
  <a class="skip-link" href="#app-main">Перейти к основному содержимому</a>
  <!-- Шапка приложения: приветственный блок с кратким описанием. -->
  <header class="app-header">
    <div class="header-top">
      <div class="header-brand">
        <img
          src="дизайн/ЛОГО.svg"
          alt="Логотип Контроль Москвы"
          class="brand-logo"
          loading="lazy"
          decoding="async"
          width="96"
          height="96"
        />
        <div class="brand-text">
          <span class="brand-tag">Контроль Москвы</span>
          <h1>Конструктор отчетных таблиц ОАТИ</h1>
        </div>
      </div>
      <div class="header-actions">
        <button id="theme-toggle" class="theme-toggle" type="button" aria-pressed="false">
          <span class="theme-toggle__glow" aria-hidden="true"></span>
          <span class="theme-toggle__icon theme-toggle__icon--sun" aria-hidden="true"></span>
          <span class="theme-toggle__icon theme-toggle__icon--moon" aria-hidden="true"></span>
          <span class="theme-toggle__label" id="theme-toggle-text">Темный режим</span>
        </button>
      </div>
    </div>
    <div class="easter-egg" id="easter-egg-message" role="status" aria-live="polite" hidden>
      Разработано Русланом Мирвеловым
    </div>
    <p class="header-subtitle">
      Единая рабочая среда для формирования отчетов: загрузите исходные данные, сопоставьте поля и получите сверстанный файл за
      несколько кликов.
    </p>
  </header>

  <aside class="credit-badge" aria-label="Информация о разработчиках">
    <span class="credit-badge__title">Разработано</span>
    <span class="credit-badge__body"
      >Отделом развития информационных систем и внедрения цифровых продуктов Информационно-аналитического управления</span
    >
    <button class="credit-badge__close" type="button" aria-label="Скрыть плашку с информацией о разработчиках">
      Ничего себе!
    </button>
  </aside>

  <main class="app-main" id="app-main">
    <!-- Блок загрузки исходных таблиц. -->
    <section class="card">
      <h2>1. Загрузка исходных данных</h2>
      <div class="file-input-group">
        <!-- Здесь загружаем таблицу с нарушениями. -->
        <label for="violations-file" class="file-label">Таблица по нарушениям (Excel)</label>
        <div class="file-input-control">
          <input type="file" id="violations-file" accept=".xlsx,.xls,.xlsm" />
          <div class="file-loader" id="violations-loader" role="status" aria-live="polite" hidden>
            <span class="spinner" aria-hidden="true"></span>
            <span class="file-loader__text">Обработка…</span>
          </div>
        </div>
      </div>
      <div class="file-input-group">
        <!-- А этот инпут для перечня объектов контроля. -->
        <label for="objects-file" class="file-label">Таблица по объектам (Excel)</label>
        <div class="file-input-control">
          <input type="file" id="objects-file" accept=".xlsx,.xls,.xlsm" />
          <div class="file-loader" id="objects-loader" role="status" aria-live="polite" hidden>
            <span class="spinner" aria-hidden="true"></span>
            <span class="file-loader__text">Обработка…</span>
          </div>
        </div>
      </div>
      <p class="hint">Файлы обрабатываются только в браузере, без отправки на сервер.</p>
    </section>

    <!-- Настройка сопоставления колонок для двух таблиц. -->
    <section class="card" id="mapping-section" hidden>
      <h2>2. Настройка соответствия столбцов</h2>
      <div class="mapping-grid">
        <div>
          <!-- Сопоставление для таблицы нарушений. -->
          <h3>Таблица нарушений</h3>
          <div id="violations-mapping" class="mapping-list"></div>
        </div>
        <div>
          <!-- Сопоставление для перечня объектов. -->
          <h3>Перечень объектов</h3>
          <div id="objects-mapping" class="mapping-list"></div>
        </div>
      </div>
      <p class="hint">Проверьте, что для каждого требуемого поля выбран корректный столбец. Значения подставляются автоматически, но их можно изменить.</p>
    </section>

    <!-- Фильтры по периодам и типам объектов. -->
    <section class="card" id="controls-section" hidden>
      <h2>3. Параметры отчета</h2>
      <div class="controls-grid">
        <fieldset class="period-card period-card--current">
          <!-- Выбор дат для отчётного периода. -->
          <legend>Отчетный период</legend>
          <div class="period-card__header">
            <span class="period-card__badge">Текущий анализ</span>
            <p class="period-card__description">Сформируйте основу отчета, выбрав фактический диапазон.</p>
          </div>
          <div class="period-card__controls">
            <label class="fancy-select fancy-date-picker">
              <span class="fancy-select__label">Начало периода</span>
              <div class="date-picker" data-picker="current-start">
                <input type="hidden" id="current-start" />
                <button
                  type="button"
                  class="date-picker__button"
                  id="current-start-trigger"
                  aria-haspopup="dialog"
                  aria-expanded="false"
                >
                  <span class="date-picker__value" data-placeholder="— Выберите дату —">— Выберите дату —</span>
                  <span class="date-picker__icon" aria-hidden="true"></span>
                </button>
                <div class="date-picker__dropdown" role="dialog" aria-modal="true" hidden></div>
              </div>
            </label>
            <label class="fancy-select fancy-date-picker">
              <span class="fancy-select__label">Конец периода</span>
              <div class="date-picker" data-picker="current-end">
                <input type="hidden" id="current-end" />
                <button
                  type="button"
                  class="date-picker__button"
                  id="current-end-trigger"
                  aria-haspopup="dialog"
                  aria-expanded="false"
                >
                  <span class="date-picker__value" data-placeholder="— Выберите дату —">— Выберите дату —</span>
                  <span class="date-picker__icon" aria-hidden="true"></span>
                </button>
                <div class="date-picker__dropdown" role="dialog" aria-modal="true" hidden></div>
              </div>
            </label>
          </div>
        </fieldset>
        <fieldset class="period-card period-card--previous">
          <!-- Вторая пара select'ов отвечает за предыдущий период. -->
          <legend>Предыдущий период</legend>
          <div class="period-card__header">
            <span class="period-card__badge">Сравнительный фон</span>
            <p class="period-card__description">Подберите интервал для сопоставления динамики.</p>
          </div>
          <div class="period-card__controls">
            <label class="fancy-select fancy-date-picker">
              <span class="fancy-select__label">Начало периода</span>
              <div class="date-picker" data-picker="previous-start">
                <input type="hidden" id="previous-start" />
                <button
                  type="button"
                  class="date-picker__button"
                  id="previous-start-trigger"
                  aria-haspopup="dialog"
                  aria-expanded="false"
                >
                  <span class="date-picker__value" data-placeholder="— Выберите дату —">— Выберите дату —</span>
                  <span class="date-picker__icon" aria-hidden="true"></span>
                </button>
                <div class="date-picker__dropdown" role="dialog" aria-modal="true" hidden></div>
              </div>
            </label>
            <label class="fancy-select fancy-date-picker">
              <span class="fancy-select__label">Конец периода</span>
              <div class="date-picker" data-picker="previous-end">
                <input type="hidden" id="previous-end" />
                <button
                  type="button"
                  class="date-picker__button"
                  id="previous-end-trigger"
                  aria-haspopup="dialog"
                  aria-expanded="false"
                >
                  <span class="date-picker__value" data-placeholder="— Выберите дату —">— Выберите дату —</span>
                  <span class="date-picker__icon" aria-hidden="true"></span>
                </button>
                <div class="date-picker__dropdown" role="dialog" aria-modal="true" hidden></div>
              </div>
            </label>
          </div>
        </fieldset>
        <fieldset class="choice-card">
          <!-- Радиокнопки переключают режим фильтрации по типам объектов. -->
          <legend>Типы объектов контроля</legend>
          <div class="choice-card__modes">
            <label class="inline-option">
              <input type="radio" name="type-mode" value="all" checked />
              <span class="inline-option__decor" aria-hidden="true"></span>
              <span class="inline-option__text">Все типы объектов</span>
            </label>
            <label class="inline-option">
              <input type="radio" name="type-mode" value="custom" />
              <span class="inline-option__decor" aria-hidden="true"></span>
              <span class="inline-option__text">Выбрать до трех типов</span>
            </label>
          </div>
          <div id="type-options" class="multi-select-root" aria-live="polite"></div>
          <p id="type-message" class="hint" role="status" aria-live="polite"></p>
        </fieldset>
        <fieldset class="choice-card">
          <legend>Наименования нарушений</legend>
          <div class="choice-card__modes">
            <label class="inline-option">
              <input type="radio" name="violation-mode" value="all" checked />
              <span class="inline-option__decor" aria-hidden="true"></span>
              <span class="inline-option__text">Все наименования</span>
            </label>
            <label class="inline-option">
              <input type="radio" name="violation-mode" value="custom" />
              <span class="inline-option__decor" aria-hidden="true"></span>
              <span class="inline-option__text">Выбрать до пяти наименований</span>
            </label>
          </div>
          <div id="violation-options" class="multi-select-root" aria-live="polite"></div>
          <p id="violation-message" class="hint" role="status" aria-live="polite"></p>
        </fieldset>
        <fieldset>
          <legend>Источник данных</legend>
          <label>
            Выбор источника
            <select id="data-source-filter">
              <option value="oati">ОАТИ</option>
              <option value="cafap">ЦАФАП</option>
              <option value="all" selected>ОАТИ и ЦАФАП</option>
            </select>
          </label>
          <p id="data-source-message" class="hint" aria-live="polite"></p>
        </fieldset>
      </div>
      <p class="hint">При выборе пользовательских типов можно отметить не более трех значений.</p>
      <p class="hint">Для пользовательского выбора нарушений доступно до пяти наименований.</p>
    </section>

    <!-- Предпросмотр и управление выгрузкой отчёта. -->
    <section class="card" id="preview-section" hidden>
      <div class="preview-header">
        <h2>4. Предпросмотр отчётной таблицы</h2>
        <div class="preview-actions">
          <!-- Кнопка пересчёта вызывает пересборку отчёта без повторной загрузки файлов. -->
          <button id="refresh-report" type="button">Пересчитать</button>
          <!-- Выгрузка в Excel становится активной только после успешного пересчёта. -->
          <button id="download-report" type="button" disabled>Выгрузить в Excel</button>
        </div>
      </div>
      <p id="preview-message" class="hint"></p>
      <div class="table-wrapper">
        <table id="report-table"></table>
      </div>
    </section>
  </main>

  <!-- Подвал со служебной подписью. -->
  <footer class="app-footer">
    <p>Формирование отчетов согласно правилам из предоставленных файлов. Все вычисления выполняются локально.</p>
  </footer>
</body>
</html>
