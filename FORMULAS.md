# Формулы расчёта показателей отчётной таблицы

Ниже собрал все вычисления, которые использует конструктор отчётов. Во всех формулах из выборки исключаются записи, у которых значение столбца «Статус нарушения» равно «Черновик». Обозначения:

- `O` — множество уникальных идентификаторов (`ID объекта`) из справочника объектов по конкретному округу.
- `I` — множество уникальных наименований объектов из таблицы нарушений за отчётный период.
- `R` — множество уникальных наименований объектов из отчётного периода, у которых значение «Результат обследования» равно «Нарушение выявлено».
- `N_curr` — количество записей в таблице нарушений за отчётный период с результатом «Нарушение выявлено».
- `N_prev_ctrl` — количество записей, попавших в предыдущий период, у которых статус — «на устранении» или «на контроле инспектора ОАТИ».
- `N_res` — количество записей в отчётном периоде со статусом «снят с контроля».
- `N_curr_ctrl` — количество записей в отчётном периоде со статусом «на устранении», «на контроле инспектора ОАТИ», «новое» или «ошибка передачи данных в ЦАФАП».
- `N_total = N_curr + N_prev_ctrl` — совокупное количество нарушений для строки отчёта.
- `N_on_ctrl = N_prev_ctrl + N_curr_ctrl` — количество нарушений, остающихся на контроле после отчётного периода.

## Показатели по каждому округу

1. **Всего объектов**: `|O|`.
2. **Проверено объектов**: `|I|`.
3. **% проверенных объектов от общего количества**: 
   
   \[
   \text{Проверено, %} =
   \begin{cases}
     0, & \text{если } |O| = 0, \\
     \frac{|I|}{|O|} \times 100, & \text{иначе.}
   \end{cases}
   \]

4. **% объектов с выявленными нарушениями**:

   \[
   \text{Нарушения, %} =
   \begin{cases}
     0, & \text{если } |I| = 0, \\
     \frac{|R|}{|I|} \times 100, & \text{иначе.}
   \end{cases}
   \]

5. **Всего нарушений**: `N_total`.
6. **Нарушения, выявленные за отчётный период**: `N_curr`.
7. **Нарушения, находящиеся на контроле с предыдущей проверки**: `N_prev_ctrl`.
8. **Устранено нарушений**: `N_res`.
9. **Нарушения на контроле**: `N_on_ctrl`.

## Итоговая строка

- Числовые показатели складываются по всем округам: например, «Всего объектов» = сумма `|O|` для каждого округа.
- Показатели «Всего выявленных нарушений», «Нарушения, выявленные за отчётный период», «Нарушения, находящиеся на контроле, с предыдущего периода», «Устранено нарушений» и «Нарушения на контроле» представляют собой сумму соответствующих счётчиков по всем округам.
- Процентные столбцы рассчитываются заново от итоговых сумм:
  
  \[
  \text{Итого проверено, %} =
  \begin{cases}
    0, & \text{если суммарное } |O| = 0, \\
    \frac{\sum |I|}{\sum |O|} \times 100, & \text{иначе,}
  \end{cases}
  \]
  
  и аналогично для показателя «% объектов с выявленными нарушениями».

## Дополнительные замечания

- Все проценты округляются до одного знака после запятой при отображении и сохраняются в Excel в формате `0.0%`.
- Для целочисленных значений используется округление до ближайшего целого перед отображением и формат `#,##0` в Excel.
- Под «контрольными статусами» для предыдущего периода понимаются значения «на устранении» и «на контроле инспектора ОАТИ» после приведения к нижнему регистру и удаления лишних пробелов. Для текущего периода при расчёте показателя «Нарушения на контроле» дополнительно учитываются статусы «новое» и «ошибка передачи данных в ЦАФАП».
- При наличии в таблице нарушений столбца `ID объекта` он используется для сопоставления записей с реестром объектов и подсчёта уникальных значений. При отсутствии идентификатора расчёт опирается на нормализованное наименование объекта.
