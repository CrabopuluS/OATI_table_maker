# Формулы расчёта показателей отчётной таблицы

Документ объясняет, как конструктор отчётов считает показатели по каждому округу и по строке «ИТОГО». Текст предназначен для специалистов, которые работают с цифрами, но не пишут код: шаги описаны простым языком и сопровождаются формулами в понятном виде.

## 1. Что нужно помнить перед расчётом

1. **Исключаем черновики.** Строки, где в колонке «Статус нарушения» указано «Черновик», не участвуют в расчётах.
2. **Учитываем пользовательские фильтры.** Если заданы типы объектов или виды нарушений, берём только те записи, которые проходят выбранные фильтры. При фильтрации по нарушениям список объектов сокращается автоматически: остаются лишь те, где в текущем периоде есть нужное нарушение.
3. **Проверяем источник данных.** Значение приводится к нижнему регистру и очищается от лишних пробелов. Подходят как точные, так и частичные совпадения.
4. **Находим объект.** Когда есть `ID объекта`, используем его. Если идентификатора нет, записи объединяются по сочетанию «нормализованное название + округ».
5. **Отбрасываем некорректные даты.** Записи без даты обследования или с неправильным форматом не попадают в расчёты.
6. **Объединяем округа ТиНАО (при необходимости).** Если включена настройка объединения, строки «НАО», «ТАО» и «ТиНАО» сворачиваются в одну строку «ТиНАО».

## 2. Основные счётчики и обозначения

| `O` - Все уникальные объекты выбранного округа. 
| Считаем уникальные `ID объекта`. Если `ID` нет, используем пару «название + округ» после приведения регистра и пробелов. 

| `I` - Объекты, у которых в отчётном периоде есть хотя бы одно нарушение. 
| Выбираем строки нарушений за период с учётом пользовательских фильтров. 

| `R` - Объекты из `I`, где обследование подтвердило нарушение («Нарушение выявлено»). 
| Берём только строки с корректной датой обследования.

| `N_curr` - Нарушения, выявленные в текущем периоде. 
| Считаем строки с результатом «Нарушение выявлено». |

| `N_prev_ctrl` - Нарушения, оставшиеся на контроле с прошлого периода. 
| Выбираем прошлый период со статусами «на устранении» и «на контроле инспектора ОАТИ». 

| `N_res` - Нарушения, снятые с контроля в текущем периоде. 
| Статус «снят с контроля». 

| `N_curr_ctrl` - Нарушения, которые остались на контроле после текущего периода. 
| Статусы «на устранении», «на контроле инспектора ОАТИ», «новое», «ошибка передачи данных в ЦАФАП».

| `N_total` - Всего нарушений, связанных с округом. 
| \( N_{total} = N_{curr} + N_{prev\_ctrl} \).

| `N_on_ctrl` - Нарушения, которые продолжают числиться на контроле. 
| \( N_{on\_ctrl} = N_{prev\_ctrl} + N_{curr\_ctrl} \). |\

## 3. Как получить показатели для каждого округа

Ниже — небольшая «шпаргалка». В первой колонке видно название столбца отчётной таблицы, во второй — человеческое объяснение, в третьей — формула или правило расчёта.

| Показатель | Что показывает | Как посчитать |
|------------|----------------|----------------|
| Всего объектов | Сколько объектов попало в выборку округа. | \( |O| \). |
| Проверено объектов | Сколько объектов реально проверили. | \( |I| \). |
| Проверено, % | Доля проверенных объектов. | Если \( |O| = 0 \), ставим `0`. Иначе \( \dfrac{|I|}{|O|} \times 100 \). |
| Нарушения, % | Доля проверенных объектов с нарушениями. | Если \( |I| = 0 \), ставим `0`. Иначе \( \dfrac{|R|}{|I|} \times 100 \). |
| Всего нарушений | Общее число нарушений, связанных с округом. | \( N_{total} \). |
| Выявлено в периоде | Нарушения, обнаруженные сейчас. | \( N_{curr} \). |
| На контроле с прошлого периода | «Хвосты» из предыдущего отчёта. | \( N_{prev\_ctrl} \). |
| Снято с контроля | Сколько нарушений закрыли. | \( N_{res} \). |
| Осталось на контроле | Нарушения, которые всё ещё в работе. | \( N_{on\_ctrl} \). |

После расчётов применяем правила округления из раздела 5 и заносим значения в таблицу.

## 4. Как формируется строка «ИТОГО»

* Сначала суммируем все числовые показатели (количество объектов, нарушений и т.п.) по округам, которые прошли фильтры.
* Затем пересчитываем проценты от полученных сумм. Здесь важно не усреднять проценты из строк, а снова использовать формулы:
  * «Проверено, %» = \( \dfrac{\sum |I|}{\sum |O|} \times 100 \) (если объектов нет, ставим `0`).
  * «% объектов с нарушениями» = \( \dfrac{\sum |R|}{\sum |I|} \times 100 \) (если \( \sum |I| = 0 \), ставим `0`).

## 5. Как отображаем значения

* Проценты округляем до одного знака после запятой и сохраняем в Excel в формате `0.0%`.
* Целые показатели округляем до ближайшего целого и экспортируем в формате `#,##0`.
* Перед показом результатов нормализуем текстовые поля: приводим к нижнему регистру и убираем лишние пробелы.
* В итоговой строке учитываются только округа, которые не исключены фильтрами пользователя.

## 6. Мини-чеклист для самопроверки

1. Применили фильтры и исключили черновики? 
2. Получили множества `O`, `I`, `R` и базовые счётчики (`N_curr`, `N_prev_ctrl`, `N_res`, `N_curr_ctrl`)?
3. Вычислили показатели 1–9 по каждому округу и округлили значения?
4. Сложили числовые показатели и пересчитали проценты для строки «ИТОГО»?
5. Проверили, что статусы, округа и даты записаны в нормализованном виде?

Если на каждый вопрос можно ответить «да», расчёт таблицы выполнен верно и готов к передаче коллегам.
