# Формулы расчёта показателей отчётной таблицы

Ниже собрал все вычисления, которые использует конструктор отчётов. Обозначения:

- `O` — множество уникальных объектов контроля по конкретному округу.
- `I` — множество объектов, обследованных в отчётном периоде (у которых в таблице нарушений есть дата внутри выбранного диапазона).
- `N_curr` — количество записей в таблице нарушений с заполненным столбцом «Наименование нарушения», дата которых попадает в отчётный период.
- `N_prev_ctrl` — количество записей с заполненным «Наименованием нарушения», дата которых попадает в предыдущий период, а статус — один из контрольных («на устранении» или «на контроле инспектора ОАТИ»).
- `N_res` — количество записей в отчётном периоде со статусом «снят с контроля».
- `N_ctrl` — количество записей в отчётном периоде с любым статусом, кроме «снят с контроля».
- `N_total = N_curr + N_prev_ctrl` — совокупное количество нарушений для строки отчёта.

## Показатели по каждому округу

1. **Всего объектов**: `|O|`.
2. **Проверено объектов**: `|I|`.
3. **% проверенных объектов от общего количества**: 
   
   \[
   \text{Проверено, %} =
   \begin{cases}
     0, & \text{если } |O| = 0, \\
     \frac{|I|}{|O|} \times 100, & \text{иначе.}
   \end{cases}
   \]

4. **% объектов с выявленными нарушениями**:

   Пусть `R` — множество объектов из текущего периода, для которых значение в столбце
   «Результат обследования» равно «Нарушение выявлено».

   \[
   \text{Нарушения, %} =
   \begin{cases}
     0, & \text{если } |I| = 0, \\
     \frac{|R|}{|I|} \times 100, & \text{иначе.}
   \end{cases}
   \]

5. **Всего выявленных нарушений**: `N_total`.
6. **Нарушения, выявленные за отчётный период**: `N_curr`.
7. **Нарушения, находящиеся на контроле, с предыдущего периода**: `N_prev_ctrl`.
8. **Устранено нарушений**: `N_res`.
9. **Нарушения на контроле**: `N_ctrl`.

## Итоговая строка

- Числовые показатели складываются по всем округам: например, «Всего объектов» = сумма `|O|` для каждого округа.
- Показатели «Всего выявленных нарушений», «Нарушения, выявленные за отчётный период», «Нарушения, находящиеся на контроле, с предыдущего периода», «Устранено нарушений» и «Нарушения на контроле» представляют собой сумму соответствующих счётчиков по всем округам.
- Процентные столбцы рассчитываются заново от итоговых сумм:
  
  \[
  \text{Итого проверено, %} =
  \begin{cases}
    0, & \text{если суммарное } |O| = 0, \\
    \frac{\sum |I|}{\sum |O|} \times 100, & \text{иначе,}
  \end{cases}
  \]
  
  и аналогично для показателя «% объектов с выявленными нарушениями».

## Дополнительные замечания

- Все проценты округляются до одного знака после запятой при отображении и сохраняются в Excel в формате `0.0%`.
- Для целочисленных значений используется округление до ближайшего целого перед отображением и формат `#,##0` в Excel.
- Под «контрольными статусами» понимаются значения «на устранении» и «на контроле инспектора ОАТИ» после приведения к нижнему регистру и удаления лишних пробелов.
