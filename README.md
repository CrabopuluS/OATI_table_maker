# Конструктор отчётных таблиц ОАТИ

Одностраничное веб-приложение для специалистов Контроля Москвы, позволяющее формировать отчёт по нарушениям ОАТИ на основе двух Excel-файлов: выгрузки нарушений и перечня объектов контроля. Обработка данных полностью выполняется в браузере пользователя без передачи на сервер, что соответствует требованиям по безопасности служебной информации.

## Структура проекта

| Файл | Назначение |
| --- | --- |
| `index.html` | Структура страницы, подключение шрифтов, скриптов и мета-тегов безопасности (CSP, управление цветовой схемой, запрет передачи реферера). |
| `style.css` | Визуальный стиль, адаптивные правила, эффекты для светлой и тёмной темы. Включены оптимизации для слабых ПК (`content-visibility`, отключение анимаций при `prefers-reduced-motion`). |
| `app.js` | Вся бизнес-логика: чтение Excel, сопоставление столбцов, фильтрация, агрегация и экспорт отчёта. Код обильно документирован и разбит на самостоятельные функции. |
| `дизайн/` | Статичные ассеты интерфейса (логотип и сопутствующая графика). |
| `FORMULAS.md` | Методические формулы для расчёта отчётных показателей (используются как справочник). |

## Требования к исходным данным

- **Поддерживаемые форматы**: `XLSX`, `XLS` и `XLSM` (без макросов).
- **Размер файла**: при размере свыше ~25–30 МиБ обработка может занимать заметное время, но жёстких ограничений нет.
- **Объём данных**: приложение обрабатывает лист целиком, поэтому при десятках тысяч строк стоит дождаться завершения индикатора.
- **Размер файла**: не более **10 МиБ**. Более крупные выгрузки необходимо разбивать.
- **Максимум строк**: `20 000` непустых записей на лист. При превышении приложение уведомит пользователя.
- **Максимум столбцов**: `120` столбцов. Избыточные данные нужно удалить или подготовить отдельные шаблоны.
- **Листы**: обрабатывается первый лист книги. Остальные игнорируются.
- **Строка заголовков**: должна содержать человекочитаемые названия столбцов. Алгоритм автоопределения находит строку с наибольшим числом текстовых значений, совпадающих с известными синонимами.
- **Дубли названий столбцов**: автоматически переименовываются с добавлением суффиксов `(2)`, `(3)` и т.д., чтобы избежать перезаписи данных.
- **Пробелы и регистр**: не влияют на сопоставление — значения нормализуются при загрузке.

## Пошаговая работа в интерфейсе

1. **Откройте** `index.html` в современном браузере (Chrome, Edge, Firefox). Запуск сервера не требуется.
2. **Выберите файлы** в блоке «Загрузка исходных данных»:
   - `Таблица по нарушениям (Excel)` — данные по нарушениям.
   - `Таблица по объектам (Excel)` — справочник объектов контроля.
3. Дождитесь окончания обработки. Индикатор отображает имя файла и статус.
4. **Проверьте сопоставление столбцов**. Автоматический алгоритм подставляет вероятные соответствия, при необходимости выберите другие.
5. **Настройте фильтры**:
   - Периоды (текущий и предыдущий) — доступны только даты, найденные в загруженных файлах.
   - Типы объектов и нарушения — можно выбрать все либо ограничиться произвольным набором.
   - Источник данных (ОАТИ, ЦАФАП или оба).
6. **Нажмите «Пересчитать»** для принудительного обновления отчёта (обычно пересчёт происходит автоматически при изменении параметров).
7. **Изучите итоговую таблицу**. Строки сгруппированы по округам, предусмотрено форматирование с подчёркиванием итогов.
8. **Скачайте Excel** через кнопку «Выгрузить». Генерируется файл, готовый к отправке в отчётность.

## Ключевые элементы интерфейса

- **Шапка**: содержит переключатель темы. Темная тема сохраняется в `localStorage`.
- **Плашка с кредитами**: информирует о подразделении разработчиков и может быть скрыта.
- **Карточки параметров**: визуально отделяют логические блоки. Благодаря `content-visibility` скрытые блоки не нагружают рендеринг.
- **Выпадающие списки и фильтры**: реализованы без внешних библиотек, полностью локализованы.
- **Предпросмотр таблицы**: имеет адаптивную оболочку и подсветку строк при наведении.
- **Экспорт**: формирует файл с числовыми форматами, объединёнными ячейками и заголовком по шаблону из `FORMULAS.md`.

## Обеспечение безопасности

- **Обработка на стороне клиента**: данные никогда не покидают браузер. Можно запускать в изолированной сети.
- **Content Security Policy**: ограничивает загрузку ресурсов собственным доменом и доверенными CDN (Google Fonts, jsDelivr). При размещении на сервере убедитесь, что CSP-заголовки совпадают с указанными в `<meta>`.
- **Referrer Policy**: отключён реферер, чтобы ссылки на исходные файлы не утекали.
- **Валидация файлов**: проверяются расширение и наличие данных. Подозрительные файлы отвергаются дружелюбным сообщением.
- **Валидация файлов**: проверяется размер, расширение и наличие данных. Подозрительные файлы отвергаются дружелюбным сообщением.
- **Санитизация имён**: отображаемые имена файлов очищаются от опасных символов.

### Рекомендации при размещении

- Настройте на сервере заголовки: `X-Content-Type-Options: nosniff`, `X-Frame-Options: SAMEORIGIN`, `Referrer-Policy: no-referrer`, `Permissions-Policy: geolocation=(), microphone=()`.
- Используйте HTTPS, чтобы исключить подмену библиотек с CDN.
- Если политика безопасности организации требует офлайн-режима, скачайте `xlsx.full.min.js` и шрифты и подключайте их локально.

## Оптимизация и производительность

- Файловые операции выполняются в асинхронной очереди с промежуточными `requestIdleCallback`/`requestAnimationFrame`, чтобы UI не зависал.
- Для тяжёлых Excel-файлов загрузка выполняется с промежуточными уступками потоку, поэтому интерфейс остаётся отзывчивым.
- Ограничение на количество строк/столбцов предотвращает зависание браузера и обеспечивает предсказуемые задержки.
- Статические секции используют `content-visibility` и `contain-intrinsic-size`, что уменьшает трудоёмкость layout на слабых ПК.
- Добавлена поддержка `prefers-reduced-motion`: при активной опции анимации и длительные переходы отключаются.
- Таблица использует «ленивое» форматирование — пересчёт выполняется по расписанию через `requestAnimationFrame`, что объединяет быстрые изменения.

## Поддержка и развитие кода

- Основная логика сосредоточена в `app.js`. Ищите функции по их назначению через комментарии:
  - **Загрузка файлов**: `loadDataset`, `readExcelFile`, `extractRecords`.
  - **Фильтры**: `updateAvailableFilters`, `renderTypeOptions`, `renderViolationOptions`.
  - **Расчёт отчёта**: `buildReport`, `buildReportRows`, вспомогательные функции нормализации.
  - **Экспорт**: `exportReportToExcel` и связанные функции форматирования.
- Каждая функция снабжена JSDoc-комментарием, который объясняет входные параметры и возвращаемые значения.
- При добавлении новых колонок в отчёт:
  1. Дополните `violationFieldDefinitions` или `objectFieldDefinitions` кандидатами заголовков.
  2. Обновите `buildReport` и `buildExcelHeaderNumbers`.
  3. Добавьте новые ячейки в `createRowElement` и `buildExportDataRow`.
- Для расширения дизайна меняйте `style.css`. Основные цветовые переменные заданы в `:root` и переопределяются для тёмной темы в `body.theme-dark`.
- При обновлении зависимостей убедитесь, что CSP и локальные пути остаются валидными.

## Развёртывание

1. Скопируйте весь репозиторий (включая папку `дизайн`).
2. Разместите файлы на любом статическом сервере (`Nginx`, `GitHub Pages`, `S3`, `IIS`).
3. Убедитесь, что MIME-типы настроены корректно: `text/html`, `text/css`, `application/javascript`, `image/svg+xml`.
4. При необходимости пропишите базовый путь в метатеге `<base>` или настройте маршрутизацию на стороне сервера.

## Тестирование и проверка качества

Перед сдачей отчёта рекомендуется выполнить:

- **Smoke-тест**: загрузить контрольные файлы и убедиться, что формулы совпадают с методическим документом.
- **Граничные случаи**:
  - Файлы с пустыми строками — они должны игнорироваться.
  - Крупные файлы (десятки тысяч строк) — приложение должно корректно завершить обработку и показать индикатор прогресса.
  - Файл с максимально допустимым размером — приложение должно корректно отработать или выдать предупреждение.
  - Проверка пользовательского режима фильтров (до трёх типов/нарушений).
- **Экспорт**: открыть выгруженный Excel в Excel/LibreOffice и убедиться, что форматирование сохранено.
- **Адаптивность**: просмотреть интерфейс в ширине 1280, 1024, 768 и 480 px.

## Известные ограничения

- Обработка только первого листа книги.
- Нет поддержки CSV и других текстовых форматов.
- Для столбцов с датой ожидаются значения в формате Excel или строковом `дд.мм.гггг`.
- При экстремально больших массивах данных возможны ощутимые задержки. В таких сценариях имеет смысл предварительно агрегировать информацию во внешних инструментах.
- При большем объёме данных, чем допускает ограничение, необходимо предварительно агрегировать их во внешних инструментах.

## Подготовка к передаче проекта

- Вся логика задокументирована в `app.js`. Передача новому исполнителю требует лишь обзора README и комментариев в коде.
- Для ускорения обучения можно провести живую сессию: показать загрузку файлов, пояснить структуру state-объекта и очереди `schedulePreviewUpdate`.
- Рекомендуется хранить эталонные выгрузки (анонимизированные) для регрессионного тестирования.

Если нужны дополнительные пояснения, смело добавляйте новые разделы в README или создавайте отдельные `docs/*.md` с примерами бизнес-правил.
